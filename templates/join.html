<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TEAM SECRET — Join</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=Cormorant+Garamond:wght@400;500;600;700&family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#000;
  --neon:#33ffff;
  --neon-soft:#77ffff;
  --glow:rgba(80,255,255,0.55);
  --glow-soft:rgba(120,255,255,0.35);
  --aura-opacity:0.55;
}

body{
  margin:0;
  font-family:'Rajdhani', sans-serif;
  background:var(--bg);
  height:100vh;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  position:relative;
}

/* Matrix & Stars */
#matrix-bg{position:absolute;inset:0;z-index:-10}
.stars{position:absolute;inset:0;z-index:-9;pointer-events:none}
.star{position:absolute;width:3px;height:3px;background:var(--neon-soft);border-radius:50%;opacity:0.7;animation:twinkle 3s infinite ease-in-out}
@keyframes twinkle{0%{opacity:.2}50%{opacity:.9}100%{opacity:.2}}

/* Neon Ring & Aura */
.neon-ring{position:absolute;width:380px;height:380px;border:3px solid rgba(80,255,255,0.25);border-radius:50%;filter:blur(1px);animation:spin 14s linear infinite;z-index:-8;box-shadow:0 0 35px var(--glow),0 0 50px var(--glow-soft)}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

.neon-aura{position:absolute;inset:0;background:radial-gradient(circle,var(--neon) 0%,rgba(0,255,255,0.18) 40%,transparent 70%);z-index:-7;animation:pulse 5s infinite alternate ease-in-out;filter:blur(40px);opacity:var(--aura-opacity)}
@keyframes pulse{0%{opacity:.45}100%{opacity:.75}}

/* Container */
.container{
  background:rgba(255,255,255,0.03);
  padding:50px 60px;
  border-radius:28px;
  border:1.5px solid rgba(100,255,255,0.25);
  backdrop-filter:blur(15px);
  text-align:center;
  position:relative;
  animation:float 4s ease-in-out infinite alternate;
  box-shadow:0 0 30px rgba(80,255,255,0.15),0 0 50px rgba(80,255,255,0.12),inset 0 0 20px rgba(80,255,255,0.06);
  z-index:2;
}
@keyframes float{0%{transform:translateY(0)}100%{transform:translateY(-10px)}}

h1{
  font-family:'Cormorant Garamond', serif;
  font-weight:700;
  font-size:3em;
  color:var(--neon-soft);
  text-shadow:0 0 15px var(--glow),0 0 30px var(--glow-soft);
  margin:0 0 10px 0;
}

p{
  font-size:1.25em;
  color:#e8fefe;
  margin-top:0;
  margin-bottom:18px;
  text-shadow:0 0 10px var(--glow-soft);
}

/* Neon Button */
.join-button{
  padding:16px 55px;
  font-size:1.25em;
  border-radius:16px;
  border:1.5px solid var(--neon-soft);
  background:rgba(0,255,255,0.1);
  color:#e8fefe;
  cursor:pointer;
  transition:.28s;
  font-family:'Cormorant Garamond', serif;
  font-weight:600;
  box-shadow:0 0 20px rgba(120,255,255,0.25), inset 0 0 12px rgba(255,255,255,0.05);
  letter-spacing:2px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin: 0 auto;
}
.join-button:hover:not(:disabled){
  background:var(--neon-soft);
  color:#000;
  transform:scale(1.1);
  box-shadow:0 0 45px var(--glow),0 0 70px var(--glow-soft);
}
.join-button:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

/* Loading Spinner */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: var(--neon);
  animation: spin 1s ease-in-out infinite;
  vertical-align: middle;
}

.error-msg {
  animation: shake 0.5s ease-in-out;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.small-note{font-size:0.9em;color:#dffefe;margin-top:12px;text-shadow:0 0 6px var(--glow-soft)}
</style>
</head>
<body>

<canvas id='matrix-bg'></canvas>
<div class='stars'></div>
<div class='neon-ring'></div>
<div class='neon-aura'></div>

<div class='container'>
  <h1>TEAM SECRET</h1>
  <p id="statusMessage">Verifying your identity…</p>
  <button id="joinBtn" class='join-button'>
    <span id="btnText">Join Now</span>
  </button>
  <div class='small-note'>Secure · Verified · Exclusive</div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
/* Matrix Background */
const canvas=document.getElementById('matrix-bg');
const ctx=canvas.getContext('2d');
function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;}
window.addEventListener('resize',resizeCanvas);resizeCanvas();

const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890@#$%^&*()*&^%+-/~{[|`]}';
const arr=chars.split('');
const fontSize=Math.max(13,Math.floor(window.innerWidth/85));
let cols=Math.floor(canvas.width/fontSize);
let drops=new Array(cols).fill(1);

function draw(){
  ctx.fillStyle='rgba(0,0,0,0.08)';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='rgba(120,255,255,0.7)';
  ctx.font=fontSize+'px monospace';
  for(let i=0;i<drops.length;i++){
    const text=arr[Math.floor(Math.random()*arr.length)];
    ctx.fillText(text,i*fontSize,drops[i]*fontSize);
    if(drops[i]*fontSize>canvas.height && Math.random()>0.975) drops[i]=0;
    drops[i]++;
  }
}
setInterval(draw,35);

/* Stars */
const starContainer=document.querySelector('.stars');
for(let i=0;i<70;i++){
  let star=document.createElement('div');
  star.classList.add('star');
  star.style.top=Math.random()*100+'%';
  star.style.left=Math.random()*100+'%';
  star.style.animationDelay=(Math.random()*2)+'s';
  starContainer.appendChild(star);
}

/* Telegram WebApp Integration */
document.addEventListener('DOMContentLoaded', () => {
  const joinBtn = document.getElementById('joinBtn');
  const btnText = document.getElementById('btnText');
  const statusMessage = document.getElementById('statusMessage');
  
  // Extract token from URL query parameter
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');
  
  const tg = window.Telegram.WebApp;
  
  // Check if running in Telegram WebApp
  const isTelegram = typeof tg !== 'undefined' && tg.initData;
  
  if (!token) {
    btnText.textContent = 'Invalid Access';
    joinBtn.disabled = true;
    joinBtn.style.background = 'rgba(255, 80, 80, 0.1)';
    joinBtn.style.borderColor = '#ff5555';
    statusMessage.textContent = 'Access denied. No valid token.';
    statusMessage.style.color = '#ff5555';
    return;
  }

  // Initialize Telegram WebApp if available
  if (isTelegram) {
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();
    
    // Optional: Show user info
    const user = tg.initDataUnsafe.user;
    if (user) {
      statusMessage.innerHTML = `Verifying <span style="color: var(--neon-soft);">${user.first_name}</span>...`;
    }
  }

  joinBtn.addEventListener('click', async () => {
    // Add loading spinner
    const spinner = document.createElement('div');
    spinner.className = 'loading-spinner';
    joinBtn.prepend(spinner);
    btnText.textContent = 'Processing...';
    joinBtn.disabled = true;

    try {
      // Verify token with server
      const verifyResponse = await fetch(`/verify-token?token=${encodeURIComponent(token)}`);
      if (!verifyResponse.ok) throw new Error('Token verification failed');
      const verifyData = await verifyResponse.json();
      
      if (!verifyData.valid) {
        throw new Error('Token expired or invalid');
      }
      
      // Get group link
      const response = await fetch(`/getgrouplink?token=${encodeURIComponent(token)}`);
      if (!response.ok) throw new Error('Failed to get group link');
      const data = await response.json();

      if (data.url) {
        // Remove spinner and update button
        spinner.remove();
        btnText.textContent = '✓ Success';
        joinBtn.style.background = 'rgba(80, 255, 80, 0.1)';
        joinBtn.style.borderColor = '#55ff55';
        
        statusMessage.textContent = 'Welcome to TEAM SECRET';
        statusMessage.style.color = '#55ff55';
        
        // Open link
        if (isTelegram && tg.openLink) {
          tg.openLink(data.url);
        } else {
          window.open(data.url, '_blank');
        }
        
        // Close WebApp after delay if in Telegram
        if (isTelegram) {
          setTimeout(() => {
            tg.close();
          }, 1500);
        }
        
      } else {
        throw new Error('No group link available');
      }
    } catch (error) {
      console.error('Error:', error);
      
      // Remove spinner and show error
      spinner.remove();
      btnText.textContent = 'Failed - Try Again';
      joinBtn.disabled = false;
      joinBtn.style.background = 'rgba(255, 80, 80, 0.1)';
      joinBtn.style.borderColor = '#ff5555';
      
      statusMessage.textContent = 'Connection error. Please try again.';
      statusMessage.style.color = '#ff5555';
      
      // Shake animation for error
      statusMessage.style.animation = 'shake 0.5s ease-in-out';
      setTimeout(() => {
        statusMessage.style.animation = '';
      }, 500);
      
      // Reset button after 3 seconds
      setTimeout(() => {
        if (joinBtn.disabled === false) {
          btnText.textContent = 'Join Now';
          joinBtn.style.background = 'rgba(0,255,255,0.1)';
          joinBtn.style.borderColor = 'var(--neon-soft)';
          statusMessage.textContent = 'Ready to join TEAM SECRET';
          statusMessage.style.color = '#e8fefe';
        }
      }, 3000);
    }
  });
});
</script>
</body>
</html>
